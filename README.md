# check-and-fix-supply-chain

2025 å¹´ 9 æœˆ npm ä¾›åº”é“¾æ”»å‡»æ£€æµ‹ä¸ä¿®å¤å·¥å…·

ä¸€ä¸ªç”¨äºæ£€æµ‹å’Œä¿®å¤ npm ä¾›åº”é“¾æ”»å‡»çš„è‡ªåŠ¨åŒ–è„šæœ¬ï¼Œä¸“é—¨é’ˆå¯¹ 2025 å¹´ 9 æœˆå‘ç°çš„æ¶æ„åŒ…ç‰ˆæœ¬è¿›è¡Œæ£€æµ‹å’Œä¿®å¤ã€‚

## ğŸš¨ èƒŒæ™¯

2025 å¹´ 9 æœˆï¼Œnpm ç”Ÿæ€ç³»ç»Ÿé­å—äº†å¤§è§„æ¨¡çš„ä¾›åº”é“¾æ”»å‡»ï¼Œå¤šä¸ªæµè¡ŒåŒ…è¢«æ³¨å…¥äº†æ¶æ„ä»£ç ã€‚æœ¬å·¥å…·ä¸“é—¨ç”¨äºæ£€æµ‹å’Œä¿®å¤è¿™äº›å—å½±å“çš„åŒ…ç‰ˆæœ¬ã€‚

ç›¸å…³é“¾æ¥ï¼š
- https://semgrep.dev/blog/2025/chalk-debug-and-color-on-npm-compromised-in-new-supply-chain-attack/
- https://jdstaerk.substack.com/p/we-just-found-malicious-code-in-the


## âœ¨ åŠŸèƒ½ç‰¹æ€§

- ğŸ” **è‡ªåŠ¨æ£€æµ‹åŒ…ç®¡ç†å™¨**ï¼šæ”¯æŒ yarnã€npmã€pnpm
- ğŸ›¡ï¸ **æ·±åº¦å®‰å…¨æ‰«æ**ï¼šä½¿ç”¨ Semgrep è¿›è¡Œæ¶æ„ä»£ç æ£€æµ‹
- ğŸ“‹ **ä¾èµ–ç‰ˆæœ¬æ£€æŸ¥**ï¼šæ£€æŸ¥é”å®šæ–‡ä»¶ä¸­çš„å—å½±å“ç‰ˆæœ¬
- ğŸ”§ **è‡ªåŠ¨ä¿®å¤**ï¼šç”Ÿæˆå¹¶åº”ç”¨å®‰å…¨ç‰ˆæœ¬ä¿®å¤æ–¹æ¡ˆ
- ğŸ“Š **è¯¦ç»†æŠ¥å‘Š**ï¼šæä¾›å®Œæ•´çš„æ£€æµ‹å’Œä¿®å¤æŠ¥å‘Š
- ğŸ”„ **å¤‡ä»½ä¿æŠ¤**ï¼šè‡ªåŠ¨å¤‡ä»½åŸå§‹é…ç½®æ–‡ä»¶

## ğŸ¯ å—å½±å“çš„åŒ…ç‰ˆæœ¬

è„šæœ¬ä¼šæ£€æµ‹ä»¥ä¸‹å—å½±å“çš„åŒ…ç‰ˆæœ¬ï¼š

- `debug@4.4.2`
- `color-name@2.0.1`
- `strip-ansi@7.1.1`
- `color@5.0.1`
- `color-convert@3.1.1`
- `color-string@2.1.1`
- `has-ansi@6.0.1`
- `ansi-styles@6.2.2`
- `ansi-regex@6.2.1`
- `supports-color@10.2.1`
- `chalk@5.6.1`
- `backslash@0.2.1`
- `wrap-ansi@9.0.1`
- `is-arrayish@0.3.3`
- `error-ex@1.3.3`
- `slice-ansi@7.1.1`
- `simple-swizzle@0.2.3`
- `chalk-template@1.1.1`
- `supports-hyperlinks@4.1.1`

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ä¸‹è½½è„šæœ¬

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/anbang/check-and-fix-supply-chain.git
cd check-and-fix-supply-chain

# æˆ–è€…ç›´æ¥ä¸‹è½½è„šæœ¬
curl -O https://raw.githubusercontent.com/anbang/check-and-fix-supply-chain/main/check-and-fix-supply-chain.sh
```

### 2. è®¾ç½®æƒé™

```bash
chmod +x check-and-fix-supply-chain.sh
```

### 3. è¿è¡Œè„šæœ¬

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹è¿è¡Œï¼š

```bash
./check-and-fix-supply-chain.sh
```

## ğŸ“‹ å‰ç½®è¦æ±‚

### å¿…éœ€å·¥å…·

- **jq**ï¼šç”¨äº JSON å¤„ç†

  ```bash
  # macOS
  brew install jq

  # Ubuntu/Debian
  sudo apt-get install jq

  # CentOS/RHEL
  sudo yum install jq
  ```

- **Semgrep**ï¼šç”¨äºæ·±åº¦å®‰å…¨æ‰«æ

  ```bash
  # ä½¿ç”¨ pip
  pip3 install semgrep

  # ä½¿ç”¨ Homebrew (macOS)
  brew install semgrep
  ```

Semgrepï¼šéœ€è¦ Python 3.9 æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚


## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œ
./check-and-fix-supply-chain.sh
```

### è„šæœ¬æ‰§è¡Œæµç¨‹

1. **æ£€æµ‹åŒ…ç®¡ç†å™¨**ï¼šè‡ªåŠ¨è¯†åˆ«é¡¹ç›®ä½¿ç”¨çš„åŒ…ç®¡ç†å™¨ï¼ˆyarn/npm/pnpmï¼‰
2. **Semgrep æ‰«æ**ï¼šä½¿ç”¨ Semgrep è¿›è¡Œæ·±åº¦æ¶æ„ä»£ç æ£€æµ‹
3. **ä¾èµ–ç‰ˆæœ¬æ£€æŸ¥**ï¼šæ£€æŸ¥é”å®šæ–‡ä»¶ä¸­çš„å—å½±å“ç‰ˆæœ¬
4. **ç”Ÿæˆä¿®å¤æ–¹æ¡ˆ**ï¼šä¸ºå—å½±å“çš„åŒ…ç”Ÿæˆå®‰å…¨ç‰ˆæœ¬ä¿®å¤æ–¹æ¡ˆ
5. **åº”ç”¨ä¿®å¤**ï¼šè‡ªåŠ¨åº”ç”¨ä¿®å¤å¹¶é‡æ–°å®‰è£…ä¾èµ–

### è¾“å‡ºç¤ºä¾‹

```
=== 2025å¹´9æœˆ npm ä¾›åº”é“¾æ”»å‡»æ£€æµ‹ä¸ä¿®å¤å·¥å…· ===
æ£€æµ‹åˆ°åŒ…ç®¡ç†å™¨: yarn
é”å®šæ–‡ä»¶: yarn.lock
å—å½±å“çš„åŒ…ç‰ˆæœ¬ï¼š
- debug@4.4.2
- color-name@2.0.1
...

=== [1/4] ä½¿ç”¨ Semgrep æ£€æŸ¥æ˜¯å¦å«å·²çŸ¥æ¶æ„ç‰ˆæœ¬ ===
âœ… Semgrep æ‰«æå®Œæˆ

=== [2/4] æ£€æŸ¥å½“å‰ä¾èµ–ä¸­çš„å—å½±å“ç‰ˆæœ¬ ===
âŒ å‘ç°å—å½±å“çš„ç‰ˆæœ¬: chalk@5.6.1

=== [3/4] ç”Ÿæˆå®‰å…¨ç‰ˆæœ¬ä¿®å¤æ–¹æ¡ˆ ===
  - åŒ…å« chalkï¼Œæ¨èé”å®šä¸ºå®‰å…¨ç‰ˆæœ¬ 5.3.0

=== [4/4] åº”ç”¨å®‰å…¨ä¿®å¤ ===
å‘ç°éœ€è¦ä¿®å¤çš„ä¾èµ–ï¼Œå¼€å§‹åº”ç”¨ä¿®å¤...
å·²å¤‡ä»½ package.json => package.json.bak
å·²æ›´æ–° package.jsonï¼Œæ·»åŠ  resolutions å­—æ®µ
æ¸…ç†å¹¶é‡æ–°å®‰è£…ä¾èµ–...
ğŸ‰ ä¿®å¤å®Œæˆï¼å·²ä½¿ç”¨å®‰å…¨ç‰ˆæœ¬æ›¿æ¢å—å½±å“ä¾èµ–ã€‚
```

## ğŸ“ æ–‡ä»¶è¯´æ˜

- `check-and-fix-supply-chain.sh`ï¼šä¸»è„šæœ¬æ–‡ä»¶
- `package.json.bak`ï¼šè‡ªåŠ¨å¤‡ä»½çš„åŸå§‹ package.jsonï¼ˆå¦‚æœè¿›è¡Œäº†ä¿®å¤ï¼‰
- `resolutions-patch.json`ï¼šç”Ÿæˆçš„ä¿®å¤æ–¹æ¡ˆæ–‡ä»¶ï¼ˆä¸´æ—¶æ–‡ä»¶ï¼‰

## ğŸ›¡ï¸ å®‰å…¨ç‰ˆæœ¬æ˜ å°„

è„šæœ¬ä¼šå°†å—å½±å“çš„åŒ…ç‰ˆæœ¬æ›¿æ¢ä¸ºä»¥ä¸‹å®‰å…¨ç‰ˆæœ¬ï¼š

| åŒ…å           | å—å½±å“ç‰ˆæœ¬ | å®‰å…¨ç‰ˆæœ¬ |
| -------------- | ---------- | -------- |
| chalk          | 5.6.1      | 5.3.0    |
| strip-ansi     | 7.1.1      | 7.1.0    |
| color-convert  | 3.1.1      | 2.0.1    |
| color-name     | 2.0.1      | 1.1.4    |
| debug          | 4.4.2      | 4.3.4    |
| ansi-regex     | 6.2.1      | 5.0.1    |
| color          | 5.0.1      | 4.1.0    |
| color-string   | 2.1.1      | 2.0.0    |
| has-ansi       | 6.0.1      | 5.0.0    |
| ansi-styles    | 6.2.2      | 6.2.1    |
| supports-color | 10.2.1     | 10.1.0   |

## ğŸ”„ åŒ…ç®¡ç†å™¨æ”¯æŒ

### Yarn

- ä½¿ç”¨ `resolutions` å­—æ®µé”å®šç‰ˆæœ¬
- æ”¯æŒ `yarn.lock` æ–‡ä»¶æ£€æµ‹

### npm

- ä½¿ç”¨ `overrides` å­—æ®µé”å®šç‰ˆæœ¬
- æ”¯æŒ `package-lock.json` æ–‡ä»¶æ£€æµ‹

### pnpm

- ä½¿ç”¨ `pnpm.overrides` å­—æ®µé”å®šç‰ˆæœ¬
- æ”¯æŒ `pnpm-lock.yaml` æ–‡ä»¶æ£€æµ‹

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¤‡ä»½é‡è¦**ï¼šè„šæœ¬ä¼šè‡ªåŠ¨å¤‡ä»½ `package.json`ï¼Œä½†å»ºè®®åœ¨è¿è¡Œå‰æ‰‹åŠ¨å¤‡ä»½æ•´ä¸ªé¡¹ç›®
2. **æµ‹è¯•ç¯å¢ƒ**ï¼šå»ºè®®å…ˆåœ¨æµ‹è¯•ç¯å¢ƒä¸­è¿è¡Œè„šæœ¬
3. **ä¾èµ–æ›´æ–°**ï¼šä¿®å¤åå¯èƒ½éœ€è¦æµ‹è¯•åº”ç”¨ç¨‹åºåŠŸèƒ½
4. **å®šæœŸæ£€æŸ¥**ï¼šå»ºè®®å®šæœŸè¿è¡Œæ­¤è„šæœ¬æ£€æŸ¥æ–°çš„ä¾›åº”é“¾æ”»å‡»

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**Q: è„šæœ¬æç¤º "æœªæ£€æµ‹åˆ°æ”¯æŒçš„åŒ…ç®¡ç†å™¨"**
A: ç¡®ä¿é¡¹ç›®æ ¹ç›®å½•å­˜åœ¨ `package.json` æ–‡ä»¶ï¼Œå¹¶ä¸”å®‰è£…äº† yarnã€npm æˆ– pnpm ä¹‹ä¸€ã€‚

**Q: æç¤º "éœ€è¦ jqï¼Œè¯·å…ˆå®‰è£…"**
A: è¯·æŒ‰ç…§å‰ç½®è¦æ±‚éƒ¨åˆ†å®‰è£… jq å·¥å…·ã€‚

**Q: Semgrep æ‰«æå¤±è´¥**
A: Semgrep æ˜¯å¯é€‰çš„ï¼Œè„šæœ¬ä¼šç»§ç»­ä½¿ç”¨å…¶ä»–æ–¹æ³•è¿›è¡Œæ£€æµ‹ã€‚

**Q: ä¿®å¤åé¡¹ç›®æ— æ³•å¯åŠ¨**
A: æ£€æŸ¥ `package.json.bak` å¤‡ä»½æ–‡ä»¶ï¼Œå¿…è¦æ—¶å¯ä»¥æ¢å¤åŸå§‹é…ç½®ã€‚

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Request æ¥æ”¹è¿›è¿™ä¸ªå·¥å…·ï¼

## ğŸ“„ è®¸å¯è¯

MIT License

## ğŸ”— ç›¸å…³é“¾æ¥

- https://semgrep.dev/blog/2025/chalk-debug-and-color-on-npm-compromised-in-new-supply-chain-attack/
- https://jdstaerk.substack.com/p/we-just-found-malicious-code-in-the

---

**âš ï¸ é‡è¦æé†’**ï¼šæ­¤å·¥å…·ä¸“é—¨é’ˆå¯¹ 2025 å¹´ 9 æœˆçš„ä¾›åº”é“¾æ”»å‡»è®¾è®¡ã€‚è¯·å®šæœŸæ›´æ–°å·¥å…·ä»¥åº”å¯¹æ–°çš„å®‰å…¨å¨èƒã€‚
